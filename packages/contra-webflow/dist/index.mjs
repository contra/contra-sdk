import {ContraClient,utils}from'@contra/client';var l="data-contra-",n={program:"program",template:"template",loading:"loading",error:"error",empty:"empty",field:"field",format:"format",repeat:"repeat",max:"max",filter:"filter",filterType:"filter-type",showWhen:"show-when",hideWhen:"hide-when",action:"action",target:"target"},g=class{constructor(){this.states=new Map;}getState(t){return this.states.has(t)||this.states.set(t,{filters:{},experts:[],loading:false,error:null,currentPage:1,totalCount:0}),this.states.get(t)}updateState(t,e){let s=this.getState(t);Object.assign(s,e),this.states.set(t,s);}},f=class{constructor(t){this.state=new g;this.debouncedReload=new Map;this.config={debug:false,loadingClass:"loading",errorClass:"error",emptyClass:"empty",autoReload:true,debounceDelay:300,maxRetries:3,...t},this.client=new ContraClient({apiKey:this.config.apiKey,debug:this.config.debug}),this.log("Runtime initialized",this.config);}async init(){this.log("Initializing runtime...");try{let t=this.findExpertContainers();this.log(`Found ${t.length} expert containers`);for(let e of t)await this.initContainer(e);this.log("Runtime initialization complete");}catch(t){throw this.log("Runtime initialization failed",t),t}}async initContainer(t){let e=this.getAttr(t,n.program);if(!e){this.log("Container missing program ID",t);return}this.log(`Initializing container for program: ${e}`);try{this.setupContainer(t,e),this.wireFilterControls(t,e),this.wireActionButtons(t,e),await this.loadExperts(t,e);}catch(s){this.log(`Failed to initialize container for program ${e}`,s),this.showError(t,s);}}setupContainer(t,e){let s=t;s.classList.add("contra-runtime"),s.setAttribute("data-program-id",e);let i=this.parseFiltersFromElement(t);this.state.updateState(e,{filters:i});let a=utils.debounce(()=>{this.loadExperts(t,e);},this.config.debounceDelay);this.debouncedReload.set(e,a),this.log(`Container setup complete for program: ${e}`,i);}wireFilterControls(t,e){let s=this.querySelectorAll(t,`[${l}${n.filter}]`);this.log(`Found ${s.length} filter controls for program: ${e}`),s.forEach(i=>{let a=this.getAttr(i,n.filter),r=this.getAttr(i,n.filterType)||"replace";if(a){if(i instanceof HTMLInputElement){let o=i.type==="range"||i.type==="number"?"input":"change";i.addEventListener(o,()=>{this.updateFilter(e,a,this.getControlValue(i),r),this.config.autoReload&&this.debouncedReload.get(e)?.();});}else i instanceof HTMLSelectElement&&i.addEventListener("change",()=>{this.updateFilter(e,a,this.getControlValue(i),r),this.config.autoReload&&this.debouncedReload.get(e)?.();});this.log(`Wired filter control: ${a} (${r})`,i);}});}wireActionButtons(t,e){this.querySelectorAll(t,`[${l}${n.action}]`).forEach(i=>{let a=this.getAttr(i,n.action),r=this.getAttr(i,n.target);a&&i.addEventListener("click",o=>{o.preventDefault(),this.handleAction(e,a,r,i);});});}async loadExperts(t,e){let s=this.state.getState(e);this.log(`Loading experts for program: ${e}`,s.filters);try{this.showLoading(t,!0),this.state.updateState(e,{loading:!0,error:null});let i=await this.client.listExperts(e,s.filters);this.log(`Loaded ${i.data.length} experts`,i),this.state.updateState(e,{experts:i.data,totalCount:i.totalCount,loading:!1}),this.renderExperts(t,i.data),this.updateUIStates(t,e),this.dispatchEvent(t,"expertsLoaded",{experts:i.data,totalCount:i.totalCount,filters:s.filters});}catch(i){this.log(`Failed to load experts for program: ${e}`,i),this.state.updateState(e,{loading:false,error:i}),this.showError(t,i),this.dispatchEvent(t,"expertsError",{error:i,context:`Loading experts for program ${e}`});}finally{this.showLoading(t,false);}}renderExperts(t,e){let s=this.querySelector(t,`[${l}${n.template}]`);if(!s){this.log("No template found in container",t);return}this.querySelectorAll(t,":scope > *:not([data-contra-template]):not([data-contra-loading]):not([data-contra-error]):not([data-contra-empty])").forEach(a=>a.remove()),e.forEach(a=>{let r=this.populateExpertCard(s,a);t.appendChild(r);}),this.log(`Rendered ${e.length} expert cards`);}populateExpertCard(t,e){let s=t.cloneNode(true);return s.removeAttribute(`${l}${n.template}`),s.style.display="",this.populateFields(s,e),this.populateRepeatingElements(s,e),this.handleConditionalDisplay(s,e),s}populateFields(t,e){this.querySelectorAll(t,`[${l}${n.field}]`).forEach(a=>{let r=this.getAttr(a,n.field),o=this.getAttr(a,n.format);if(!r||!(r in e))return;let c=e[r];this.setElementValue(a,c,o);}),this.querySelectorAll(t,"[data-contra-stars]").forEach(a=>{e.averageReviewScore&&(a.innerHTML=utils.renderStars(e.averageReviewScore));});}setElementValue(t,e,s){if(e!=null)if(t instanceof HTMLImageElement)t.src=String(e),t.alt=t.alt||"Image";else if(t instanceof HTMLAnchorElement)t.href=String(e),t.textContent?.trim()||(t.textContent=String(e));else if(t instanceof HTMLInputElement)t.value=String(e);else {let i=String(e);if(s)switch(s){case "currency":i=typeof e=="number"?`$${e}`:i;break;case "rate":i=utils.formatRate(typeof e=="number"?e:null);break;case "number":i=typeof e=="number"?e.toLocaleString():i;break;case "truncate":i=i.length>100?i.substring(0,97)+"...":i;break}t.textContent=i;}}populateRepeatingElements(t,e){this.querySelectorAll(t,`[${l}${n.repeat}]`).forEach(i=>{let a=this.getAttr(i,n.repeat),r=parseInt(this.getAttr(i,n.max)||"10");a==="projects"&&e.projects?this.populateRepeatingContainer(i,e.projects.slice(0,r)):a==="socialLinks"&&e.socialLinks?this.populateRepeatingContainer(i,e.socialLinks.slice(0,r)):a==="skillTags"&&e.skillTags&&this.populateRepeatingContainer(i,e.skillTags.slice(0,r).map(o=>({name:o})));});}populateRepeatingContainer(t,e){let s=t.firstElementChild;s&&(t.innerHTML="",e.forEach(i=>{let a=s.cloneNode(true);this.populateFields(a,i),t.appendChild(a);}),e.length===0&&(t.style.display="none"));}handleConditionalDisplay(t,e){this.querySelectorAll(t,`[${l}${n.showWhen}], [${l}${n.hideWhen}]`).forEach(i=>{let a=this.getAttr(i,n.showWhen),r=this.getAttr(i,n.hideWhen),o=true;a&&(o=this.evaluateCondition(e,a)),r&&(o=o&&!this.evaluateCondition(e,r)),i.style.display=o?"":"none";});}evaluateCondition(t,e){let[s,i,a]=e.split(":"),r=t[s];if(r==null)return  false;switch(i){case ">":return Number(r)>Number(a);case "<":return Number(r)<Number(a);case ">=":return Number(r)>=Number(a);case "<=":return Number(r)<=Number(a);default:return String(r).toLowerCase()===a.toLowerCase()}}updateUIStates(t,e){let s=this.state.getState(e),i=this.querySelector(t,`[${l}${n.empty}]`);i&&(i.style.display=s.experts.length===0?"":"none"),this.querySelectorAll(t,"[data-contra-pagination-info]").forEach(o=>{let{currentPage:c,totalCount:u}=s,p=s.filters.limit||20,E=Math.ceil(u/p);o.textContent=`Page ${c} of ${E} (${u} total)`;}),this.querySelectorAll(t,"[data-contra-filter-summary]").forEach(o=>{let c=Object.entries(s.filters).filter(([u,p])=>p!=null&&p!=="").map(([u,p])=>`${u}: ${p}`).join(", ");o.textContent=c||"No filters applied";});}getAttr(t,e){return t.getAttribute(`${l}${e}`)}querySelector(t,e){return t.querySelector(e)}querySelectorAll(t,e){return Array.from(t.querySelectorAll(e))}findExpertContainers(){return Array.from(document.querySelectorAll(`[${l}${n.program}]`))}parseFiltersFromElement(t){let e={};return Object.entries({available:"available",languages:"languages",location:"location","min-rate":"minRate","max-rate":"maxRate",sort:"sortBy",limit:"limit",offset:"offset"}).forEach(([i,a])=>{let r=this.getAttr(t,i);r!=null&&(a==="available"?e[a]=r==="true":a==="languages"?e[a]=r.split(",").map(o=>o.trim()):["minRate","maxRate","limit","offset"].includes(a)?e[a]=parseInt(r):e[a]=r);}),e}getControlValue(t){if(t instanceof HTMLInputElement)switch(t.type){case "checkbox":return t.checked;case "number":case "range":return t.valueAsNumber;default:return t.value}else if(t instanceof HTMLSelectElement)return t.multiple?Array.from(t.selectedOptions).map(e=>e.value):t.value;return null}updateFilter(t,e,s,i="replace"){let r={...this.state.getState(t).filters};if(i==="append"&&Array.isArray(r[e])){let c=r[e];r[e]=[...c,s];}else r[e]=s;this.state.updateState(t,{filters:r});let o={filters:r,element:document.querySelector(`[data-program-id="${t}"]`)};this.dispatchEvent(document,"filterChange",o);}handleAction(t,e,s,i){let a=this.state.getState(t);switch(e){case "next-page":this.updateFilter(t,"offset",(a.filters.offset||0)+(a.filters.limit||20));break;case "prev-page":this.updateFilter(t,"offset",Math.max(0,(a.filters.offset||0)-(a.filters.limit||20)));break;case "clear-filters":this.state.updateState(t,{filters:{}});break;case "reload":this.client.clearCache(`experts:${t}`);break}this.config.autoReload&&this.debouncedReload.get(t)?.();}showLoading(t,e){let s=this.querySelector(t,`[${l}${n.loading}]`);s&&(s.style.display=e?"":"none"),t.classList.toggle(this.config.loadingClass,e);}showError(t,e){let s=this.querySelector(t,`[${l}${n.error}]`);s&&(s.textContent=e.message,s.style.display=""),t.classList.add(this.config.errorClass),this.log("Error displayed",e);}dispatchEvent(t,e,s){let i=new CustomEvent(`contra:${e}`,{detail:s});t.dispatchEvent(i);}log(t,...e){this.config.debug&&console.log(`[ContraWebflow] ${t}`,...e);}};function m(){let d=document.getElementById("contra-config");if(!d){console.warn("[ContraWebflow] No config element found. Runtime not initialized.");return}try{let t=JSON.parse(d.textContent||"{}"),e=new f(t);window.contraRuntime=e,e.init().catch(s=>{console.error("[ContraWebflow] Runtime initialization failed:",s);});}catch(t){console.error("[ContraWebflow] Failed to parse config:",t);}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m();export{f as ContraWebflowRuntime};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map