import {ContraClient,utils}from'@contra/client';var l="data-contra-",n={program:"program",template:"template",loading:"loading",error:"error",empty:"empty",field:"field",format:"format",repeat:"repeat",max:"max",filter:"filter",filterType:"filter-type",showWhen:"show-when",hideWhen:"hide-when",action:"action",target:"target"},h=class{constructor(){this.states=new Map;}getState(e){return this.states.has(e)||this.states.set(e,{filters:{},experts:[],loading:false,error:null,currentPage:1,totalCount:0}),this.states.get(e)}updateState(e,t){let i=this.getState(e);Object.assign(i,t),this.states.set(e,i);}},f=class{constructor(e){this.state=new h;this.debouncedReload=new Map;this.config={debug:false,loadingClass:"loading",errorClass:"error",emptyClass:"empty",autoReload:true,debounceDelay:300,maxRetries:3,...e},this.client=new ContraClient({apiKey:this.config.apiKey,debug:this.config.debug}),this.log("Runtime initialized",this.config);}async init(){this.log("Initializing runtime...");try{let e=this.findExpertContainers();this.log(`Found ${e.length} expert containers`);for(let t of e)await this.initContainer(t);this.log("Runtime initialization complete");}catch(e){throw this.log("Runtime initialization failed",e),e}}async initContainer(e){let t=this.getAttr(e,n.program);if(!t){this.log("Container missing program ID",e);return}this.log(`Initializing container for program: ${t}`);try{this.setupContainer(e,t),this.wireFilterControls(e,t),this.wireActionButtons(e,t),await this.loadExperts(e,t);}catch(i){this.log(`Failed to initialize container for program ${t}`,i),this.showError(e,i);}}setupContainer(e,t){let i=e;i.classList.add("contra-runtime"),i.setAttribute("data-program-id",t);let a=this.parseFiltersFromElement(e);this.state.updateState(t,{filters:a});let s=utils.debounce(()=>{this.loadExperts(e,t);},this.config.debounceDelay);this.debouncedReload.set(t,s),this.log(`Container setup complete for program: ${t}`,a);}wireFilterControls(e,t){let i=this.querySelectorAll(e,`[${l}${n.filter}]`);this.log(`Found ${i.length} filter controls for program: ${t}`),i.forEach(a=>{let s=this.getAttr(a,n.filter),r=this.getAttr(a,n.filterType)||"replace";if(s){if(a instanceof HTMLInputElement){let o=a.type==="range"||a.type==="number"?"input":"change";a.addEventListener(o,()=>{this.updateFilter(t,s,this.getControlValue(a),r),this.config.autoReload&&this.debouncedReload.get(t)?.();});}else a instanceof HTMLSelectElement&&a.addEventListener("change",()=>{this.updateFilter(t,s,this.getControlValue(a),r),this.config.autoReload&&this.debouncedReload.get(t)?.();});this.log(`Wired filter control: ${s} (${r})`,a);}});}wireActionButtons(e,t){this.querySelectorAll(e,`[${l}${n.action}]`).forEach(a=>{let s=this.getAttr(a,n.action),r=this.getAttr(a,n.target);s&&a.addEventListener("click",o=>{o.preventDefault(),this.handleAction(t,s,r,a);});});}async loadExperts(e,t){let i=this.state.getState(t);this.log(`Loading experts for program: ${t}`,i.filters);try{this.showLoading(e,!0),this.state.updateState(t,{loading:!0,error:null});let a=await this.client.listExperts(t,i.filters);this.log(`Loaded ${a.data.length} experts`,a),this.state.updateState(t,{experts:a.data,totalCount:a.totalCount,loading:!1}),this.renderExperts(e,a.data),this.updateUIStates(e,t),this.dispatchEvent(e,"expertsLoaded",{experts:a.data,totalCount:a.totalCount,filters:i.filters});}catch(a){this.log(`Failed to load experts for program: ${t}`,a),this.state.updateState(t,{loading:false,error:a}),this.showError(e,a),this.dispatchEvent(e,"expertsError",{error:a,context:`Loading experts for program ${t}`});}finally{this.showLoading(e,false);}}renderExperts(e,t){let i=this.querySelector(e,`[${l}${n.template}]`);if(!i){this.log("No template found in container",e);return}this.querySelectorAll(e,":scope > *:not([data-contra-template]):not([data-contra-loading]):not([data-contra-error]):not([data-contra-empty])").forEach(s=>s.remove()),t.forEach(s=>{let r=this.populateExpertCard(i,s);e.appendChild(r);}),this.log(`Rendered ${t.length} expert cards`);}populateExpertCard(e,t){let i=e.cloneNode(true);return i.removeAttribute(`${l}${n.template}`),i.style.display="",this.populateFields(i,t),this.populateRepeatingElements(i,t),this.handleConditionalDisplay(i,t),i}populateFields(e,t){this.querySelectorAll(e,`[${l}${n.field}]`).forEach(s=>{let r=this.getAttr(s,n.field),o=this.getAttr(s,n.format);if(!r||!(r in t))return;let c=t[r];this.setElementValue(s,c,o);}),this.querySelectorAll(e,"[data-contra-stars]").forEach(s=>{t.averageReviewScore&&(s.innerHTML=utils.renderStars(t.averageReviewScore));});}setElementValue(e,t,i){if(t!=null){if(this.isMediaField(e)&&typeof t=="string"){this.setMediaValue(e,t);return}if(e instanceof HTMLAnchorElement)e.href=String(t),e.textContent?.trim()||(e.textContent=String(t));else if(e instanceof HTMLInputElement)e.value=String(t);else {let a=String(t);if(i)switch(i){case "currency":a=typeof t=="number"?`$${t}`:a;break;case "rate":a=utils.formatRate(typeof t=="number"?t:null);break;case "number":a=typeof t=="number"?t.toLocaleString():a;break;case "truncate":a=a.length>100?a.substring(0,97)+"...":a;break}e.textContent=a;}}}isMediaField(e){let t=this.getAttr(e,n.field);return t==="coverUrl"||t==="avatarUrl"||(t?.toLowerCase().includes("url")??false)}setMediaValue(e,t){let i=this.detectMediaType(t),a=e.parentElement;if(!a){this.log("Media element has no parent for replacement",e);return}e.remove();let s;switch(i){case "video":s=this.createVideoElement(t,e);break;case "image":default:s=this.createImageElement(t,e);break}this.transferAttributes(e,s),a.appendChild(s),this.log(`Created ${i} element for URL: ${t}`);}detectMediaType(e){let t=e.toLowerCase(),a=[".mp4",".webm",".mov",".avi",".mkv",".ogg"].some(r=>t.includes(r)),s=t.includes("cloudinary.com/")&&t.includes("/video/");return a||s?"video":"image"}createVideoElement(e,t){let i=document.createElement("video");return i.src=e,i.muted=true,i.loop=true,i.playsInline=true,i.preload="metadata",i.controls=false,i.style.width="100%",i.style.height="100%",i.style.objectFit="cover",i.style.borderRadius="inherit",i.onerror=()=>{this.log(`Video failed to load: ${e}`);let a=this.extractVideoThumbnail(e);if(a){let s=this.createImageElement(a,t);i.parentElement?.replaceChild(s,i);}else i.style.background="#f3f4f6",i.style.position="relative",i.innerHTML='<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#9ca3af;font-size:12px;">Video unavailable</div>';},i.addEventListener("mouseenter",()=>{i.currentTime=0,i.play().catch(()=>{});}),i.addEventListener("mouseleave",()=>{i.pause(),i.currentTime=0;}),i}createImageElement(e,t){let i=document.createElement("img");return i.src=e,i.alt=t.getAttribute("alt")||"Media content",i.loading="lazy",i.style.width="100%",i.style.height="100%",i.style.objectFit="cover",i.style.borderRadius="inherit",i.onerror=()=>{this.log(`Image failed to load: ${e}`),i.style.background="#f3f4f6",i.style.opacity="0.5",i.alt="Image unavailable",i.style.position="relative";let a=document.createElement("div");a.style.cssText=`
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #9ca3af;
        font-size: 12px;
        text-align: center;
      `,a.textContent="\u{1F5BC}\uFE0F Image unavailable",i.parentElement?.appendChild(a);},i}extractVideoThumbnail(e){return e.includes("cloudinary.com/")&&e.includes("/video/")?e.replace("/video/","/image/").replace(/\.(mp4|webm|mov|avi|mkv)$/i,".jpg").replace("fl_progressive","f_auto,q_auto,c_fill"):null}transferAttributes(e,t){if(e.className&&(t.className=e.className),Array.from(e.attributes).forEach(i=>{i.name.startsWith("data-")&&i.name!==`${l}${n.field}`&&t.setAttribute(i.name,i.value);}),e.getAttribute("style")){let i=t.getAttribute("style")||"";t.setAttribute("style",i+"; "+e.getAttribute("style"));}}populateRepeatingElements(e,t){this.querySelectorAll(e,`[${l}${n.repeat}]`).forEach(a=>{let s=this.getAttr(a,n.repeat),r=parseInt(this.getAttr(a,n.max)||"10");s==="projects"&&t.projects?this.populateRepeatingContainer(a,t.projects.slice(0,r)):s==="socialLinks"&&t.socialLinks?this.populateRepeatingContainer(a,t.socialLinks.slice(0,r)):s==="skillTags"&&t.skillTags&&this.populateRepeatingContainer(a,t.skillTags.slice(0,r).map(o=>({name:o})));});}populateRepeatingContainer(e,t){let i=e.firstElementChild;i&&(e.innerHTML="",t.forEach(a=>{let s=i.cloneNode(true);this.populateFields(s,a),e.appendChild(s);}),t.length===0&&(e.style.display="none"));}handleConditionalDisplay(e,t){this.querySelectorAll(e,`[${l}${n.showWhen}], [${l}${n.hideWhen}]`).forEach(a=>{let s=this.getAttr(a,n.showWhen),r=this.getAttr(a,n.hideWhen),o=true;s&&(o=this.evaluateCondition(t,s)),r&&(o=o&&!this.evaluateCondition(t,r)),a.style.display=o?"":"none";});}evaluateCondition(e,t){let[i,a,s]=t.split(":"),r=e[i];if(r==null)return  false;switch(a){case ">":return Number(r)>Number(s);case "<":return Number(r)<Number(s);case ">=":return Number(r)>=Number(s);case "<=":return Number(r)<=Number(s);default:return String(r).toLowerCase()===s.toLowerCase()}}updateUIStates(e,t){let i=this.state.getState(t),a=this.querySelector(e,`[${l}${n.empty}]`);a&&(a.style.display=i.experts.length===0?"":"none"),this.querySelectorAll(e,"[data-contra-pagination-info]").forEach(o=>{let{currentPage:c,totalCount:u}=i,d=i.filters.limit||20,E=Math.ceil(u/d);o.textContent=`Page ${c} of ${E} (${u} total)`;}),this.querySelectorAll(e,"[data-contra-filter-summary]").forEach(o=>{let c=Object.entries(i.filters).filter(([u,d])=>d!=null&&d!=="").map(([u,d])=>`${u}: ${d}`).join(", ");o.textContent=c||"No filters applied";});}getAttr(e,t){return e.getAttribute(`${l}${t}`)}querySelector(e,t){return e.querySelector(t)}querySelectorAll(e,t){return Array.from(e.querySelectorAll(t))}findExpertContainers(){return Array.from(document.querySelectorAll(`[${l}${n.program}]`))}parseFiltersFromElement(e){let t={};return Object.entries({available:"available",languages:"languages",location:"location","min-rate":"minRate","max-rate":"maxRate",sort:"sortBy",limit:"limit",offset:"offset"}).forEach(([a,s])=>{let r=this.getAttr(e,a);r!=null&&(s==="available"?t[s]=r==="true":s==="languages"?t[s]=r.split(",").map(o=>o.trim()):["minRate","maxRate","limit","offset"].includes(s)?t[s]=parseInt(r):t[s]=r);}),t}getControlValue(e){if(e instanceof HTMLInputElement)switch(e.type){case "checkbox":return e.checked;case "number":case "range":return e.valueAsNumber;default:return e.value}else if(e instanceof HTMLSelectElement)return e.multiple?Array.from(e.selectedOptions).map(t=>t.value):e.value;return null}updateFilter(e,t,i,a="replace"){let r={...this.state.getState(e).filters};if(a==="append"&&Array.isArray(r[t])){let c=r[t];r[t]=[...c,i];}else r[t]=i;this.state.updateState(e,{filters:r});let o={filters:r,element:document.querySelector(`[data-program-id="${e}"]`)};this.dispatchEvent(document,"filterChange",o);}handleAction(e,t,i,a){let s=this.state.getState(e);switch(t){case "next-page":this.updateFilter(e,"offset",(s.filters.offset||0)+(s.filters.limit||20));break;case "prev-page":this.updateFilter(e,"offset",Math.max(0,(s.filters.offset||0)-(s.filters.limit||20)));break;case "clear-filters":this.state.updateState(e,{filters:{}});break;case "reload":this.client.clearCache(`experts:${e}`);break}this.config.autoReload&&this.debouncedReload.get(e)?.();}showLoading(e,t){let i=this.querySelector(e,`[${l}${n.loading}]`);i&&(i.style.display=t?"":"none"),e.classList.toggle(this.config.loadingClass,t);}showError(e,t){let i=this.querySelector(e,`[${l}${n.error}]`);i&&(i.textContent=t.message,i.style.display=""),e.classList.add(this.config.errorClass),this.log("Error displayed",t);}dispatchEvent(e,t,i){let a=new CustomEvent(`contra:${t}`,{detail:i});e.dispatchEvent(a);}log(e,...t){this.config.debug&&console.log(`[ContraWebflow] ${e}`,...t);}};function g(){let p=document.getElementById("contra-config");if(!p){console.warn("[ContraWebflow] No config element found. Runtime not initialized.");return}try{let e=JSON.parse(p.textContent||"{}"),t=new f(e);window.contraRuntime=t,t.init().catch(i=>{console.error("[ContraWebflow] Runtime initialization failed:",i);});}catch(e){console.error("[ContraWebflow] Failed to parse config:",e);}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();export{f as ContraWebflowRuntime};//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map