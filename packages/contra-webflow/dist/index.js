'use strict';var client=require('@contra/client');var c="data-contra-",l={listId:"list-id",program:"program",template:"template",loading:"loading",error:"error",empty:"empty",field:"field",format:"format",repeat:"repeat",max:"max",limit:"limit",action:"action",listTarget:"list-target",showWhen:"show-when",hideWhen:"hide-when"},g=class{constructor(){this.states=new Map;}getState(t){return this.states.has(t)||this.states.set(t,{filters:{},experts:[],loading:false,error:null,offset:0,limit:20,totalCount:0,hasNextPage:false}),this.states.get(t)}updateState(t,e){let i=this.getState(t);Object.assign(i,e),this.states.set(t,i);}},p=class{constructor(t){this.state=new g;this.debouncedReload=new Map;this.config={debug:false,loadingClass:"loading",errorClass:"error",emptyClass:"empty",videoAutoplay:false,videoHoverPlay:true,videoMuted:true,videoLoop:true,videoControls:false,...t},this.client=new client.ContraClient({apiKey:this.config.apiKey,debug:this.config.debug}),this.log("Runtime initialized",this.config);}async init(){this.log("Initializing runtime...");try{let t=this.querySelectorAll(document.body,`[${c}${l.listId}]`);this.log(`Found ${t.length} lists to initialize.`);for(let e of t)await this.initList(e);this.wireActionButtons(),this.wireFilterControls(),this.log("Runtime initialization complete");}catch(t){throw this.log("Runtime initialization failed",t),t}}async initList(t){let e=this.getAttr(t,l.listId),i=this.getAttr(t,l.program);if(!e||!i){this.log("List element is missing required attributes `data-contra-list-id` or `data-contra-program`.",t);return}this.log(`Initializing list: ${e} for program: ${i}`);try{t.setAttribute("data-contra-initialized","true");let a=await this.getAvailableFilters(i);this.populateFilterControls(e,a);let s=this.parseFiltersFromElement(t),n=parseInt(this.getAttr(t,l.limit)||"20",10);this.state.updateState(e,{filters:s,limit:n,offset:s.offset||0}),this.log(`List setup complete for: ${e}`,{initialFilters:s,limit:n}),await this.loadExperts(e,i);}catch(a){this.log(`Failed to initialize list ${e}`,a),this.showError(t,a);}}wireActionButtons(){this.querySelectorAll(document.body,`[${c}${l.action}]`).forEach(e=>{let i=this.getAttr(e,l.action),a=this.getAttr(e,l.listTarget);if(!i||!a){this.log("Action button is missing required `data-contra-action` or `data-contra-list-target` attributes.",e);return}e.addEventListener("click",s=>{s.preventDefault(),this.handleAction(i,a,e);});});}async loadExperts(t,e,i=false){let a=this.querySelector(document.body,`[${c}${l.listId}="${t}"]`);if(!a){this.log(`Cannot find list element with ID: ${t}`);return}let s=this.state.getState(t),n={...s.filters,limit:s.limit,offset:s.offset};this.log(`Loading experts for list: ${t}`,n);try{this.showLoading(a,!0),this.state.updateState(t,{loading:!0,error:null});let o=await this.client.listExperts(e,n);this.log(`Loaded ${o.data.length} experts for list ${t}`,o);let r=o.data,d=i?[...s.experts,...r]:r;this.state.updateState(t,{experts:d,totalCount:o.totalCount,offset:s.offset+r.length,hasNextPage:r.length===s.limit,loading:!1}),this.renderExperts(a,r,i),this.updateUIStates(a,t);}catch(o){this.log(`Failed to load experts for list: ${t}`,o),this.state.updateState(t,{loading:false,error:o}),this.showError(a,o);}finally{this.showLoading(a,false);}}renderExperts(t,e,i){let a=this.querySelector(t,`[${c}${l.template}]`);if(!a){this.log("No template found in list",t);return}i||this.querySelectorAll(t,".contra-rendered-item").forEach(o=>o.remove());let s=document.createDocumentFragment();e.forEach(n=>{let o=this.populateExpertCard(a,n);s.appendChild(o);}),t.appendChild(s),this.log(`Rendered ${e.length} expert cards into list`,t);}populateExpertCard(t,e){let i=t.cloneNode(true);return i.classList.add("contra-rendered-item"),i.removeAttribute(`${c}${l.template}`),i.style.display="",this.populateFields(i,e),this.populateRepeatingElements(i,e),this.handleConditionalDisplay(i,e),i}populateFields(t,e){this.querySelectorAll(t,`[${c}${l.field}]`).forEach(s=>{let n=this.getAttr(s,l.field),o=this.getAttr(s,l.format);if(!n||!(n in e))return;let r=e[n];this.setElementValue(s,r,o);}),this.querySelectorAll(t,"[data-contra-stars]").forEach(s=>{e.averageReviewScore&&this.renderStarRating(s,e.averageReviewScore);});}setElementValue(t,e,i){if(!(e==null||e==="")){if(this.isMediaField(t)&&typeof e=="string"&&e.trim()){this.setMediaValue(t,e);return}if(t instanceof HTMLAnchorElement)t.href=String(e),t.children.length===0&&!t.textContent?.trim()&&(t.textContent=String(e));else if(t instanceof HTMLInputElement)t.value=String(e);else if(t instanceof HTMLImageElement)t.src=String(e),t.alt=t.alt||"Image";else {let a=String(e);if(i)switch(i){case "currency":a=typeof e=="number"?`$${e}`:a;break;case "rate":a=client.utils.formatRate(typeof e=="number"?e:null);break;case "rating":a=typeof e=="number"?e.toFixed(1):a;break;case "earnings":typeof e=="number"&&(e>=1e6?a=`$${Math.floor(e/1e6)}M+`:e>=1e3?a=`$${Math.floor(e/1e3)}k+`:a=`$${e}`);break;case "number":a=typeof e=="number"?e.toLocaleString():a;break;case "truncate":a=a.length>100?a.substring(0,97)+"...":a;break;case "boolean":a=e?"Yes":"No";break;case "availability":a=e?"Available":"Not Available";break}t.textContent=a;}}}renderStarRating(t,e){let i=Math.floor(e),a=e%1>=.5,s=5-i-(a?1:0),n="";for(let r=0;r<i;r++)n+='<span class="contra-star contra-star-full">\u2605</span>';a&&(n+='<span class="contra-star contra-star-half">\u2605</span>');for(let r=0;r<s;r++)n+='<span class="contra-star contra-star-empty">\u2606</span>';t.innerHTML=n;let o=t.closest("[data-contra-template]")||t.closest(".expert-card");o&&this.querySelectorAll(o,"[data-contra-rating-text]").forEach(d=>{d.textContent=e.toFixed(1);});}isMediaField(t){return this.getAttr(t,l.field)==="coverUrl"}setMediaValue(t,e){let i=this.detectMediaType(e),a=t.parentElement;if(!a){this.log("Media element has no parent for replacement",t);return}t.remove();let s;switch(i){case "video":s=this.createVideoElement(e,t);break;case "image":default:s=this.createImageElement(e,t);break}this.transferAttributes(t,s),a.appendChild(s),this.log(`Created ${i} element for URL: ${e}`);}detectMediaType(t){if(!t||typeof t!="string")return this.log("Invalid URL provided to detectMediaType:",t),"image";let e=t.toLowerCase(),a=[".mp4",".webm",".mov",".avi",".mkv",".ogg"].some(n=>e.includes(n)),s=e.includes("cloudinary.com/")&&e.includes("/video/");return a||s?"video":"image"}createVideoElement(t,e){let i=document.createElement("video");return i.src=t,i.muted=this.config.videoMuted,i.loop=this.config.videoLoop,i.playsInline=true,i.preload="metadata",i.controls=this.config.videoControls,i.style.width="100%",i.style.height="100%",i.style.objectFit="cover",i.style.borderRadius="inherit",this.config.videoAutoplay&&(i.autoplay=true,i.setAttribute("autoplay","")),i.onerror=()=>{this.log(`Video failed to load: ${t}`);let a=this.extractVideoThumbnail(t);if(a){let s=this.createImageElement(a,e);i.parentElement?.replaceChild(s,i);}else i.style.background="#f3f4f6",i.style.position="relative",i.innerHTML='<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#9ca3af;font-size:12px;">Video unavailable</div>';},this.config.videoHoverPlay&&!this.config.videoAutoplay&&(i.addEventListener("mouseenter",()=>{i.currentTime=0,i.play().catch(()=>{});}),i.addEventListener("mouseleave",()=>{i.pause(),i.currentTime=0;})),i}createImageElement(t,e){let i=document.createElement("img");return i.src=t,i.alt=e.getAttribute("alt")||"Media content",i.loading="lazy",i.style.width="100%",i.style.height="100%",i.style.objectFit="cover",i.style.borderRadius="inherit",i.onerror=()=>{this.log(`Image failed to load: ${t}`),i.style.background="#f3f4f6",i.style.opacity="0.5",i.alt="Image unavailable",i.style.position="relative";let a=document.createElement("div");a.style.cssText=`
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #9ca3af;
        font-size: 12px;
        text-align: center;
      `,a.textContent="\u{1F5BC}\uFE0F Image unavailable",i.parentElement?.appendChild(a);},i}extractVideoThumbnail(t){return t.includes("cloudinary.com/")&&t.includes("/video/")?t.replace("/video/","/image/").replace(/\.(mp4|webm|mov|avi|mkv)$/i,".jpg").replace("fl_progressive","f_auto,q_auto,c_fill"):null}transferAttributes(t,e){if(t.className&&(e.className=t.className),Array.from(t.attributes).forEach(i=>{i.name.startsWith("data-")&&i.name!==`${c}${l.field}`&&e.setAttribute(i.name,i.value);}),t.getAttribute("style")){let i=e.getAttribute("style")||"";e.setAttribute("style",i+"; "+t.getAttribute("style"));}}populateRepeatingElements(t,e){this.querySelectorAll(t,`[${c}${l.repeat}]`).forEach(a=>{let s=this.getAttr(a,l.repeat),n=parseInt(this.getAttr(a,l.max)||"10");s==="projects"&&e.projects?this.populateRepeatingContainer(a,e.projects.slice(0,n)):s==="socialLinks"&&e.socialLinks?this.populateRepeatingContainer(a,e.socialLinks.slice(0,n)):s==="skillTags"&&e.skillTags&&this.populateRepeatingContainer(a,e.skillTags.slice(0,n).map(o=>({name:o})));});}populateRepeatingContainer(t,e){let i=t.firstElementChild;i&&(t.innerHTML="",e.forEach(a=>{let s=i.cloneNode(true);this.populateFields(s,a),t.appendChild(s);}),e.length===0&&(t.style.display="none"));}handleConditionalDisplay(t,e){this.querySelectorAll(t,`[${c}${l.showWhen}], [${c}${l.hideWhen}]`).forEach(a=>{let s=this.getAttr(a,l.showWhen),n=this.getAttr(a,l.hideWhen),o=true;s&&(o=this.evaluateCondition(e,s)),n&&(o=o&&!this.evaluateCondition(e,n)),a.style.display=o?"":"none";});}evaluateCondition(t,e){if(!e||typeof e!="string")return this.log("Invalid condition provided:",e),false;let i=e.split(":");if(i.length<2)return this.log("Invalid condition format:",e),false;let a=i[0],s=i.slice(1).join(":"),n=t[a];if(this.log(`Evaluating condition: ${a} (${n}, type: ${typeof n}) against ${s}`),n==null)return this.log(`Field '${a}' is null/undefined, condition fails`),false;if(s.startsWith(">=")){let o=s.substring(2),r=Number(n)>=Number(o);return this.log(`Comparison: ${n} >= ${o} = ${r}`),r}else if(s.startsWith("<=")){let o=s.substring(2),r=Number(n)<=Number(o);return this.log(`Comparison: ${n} <= ${o} = ${r}`),r}else if(s.startsWith(">")){let o=s.substring(1),r=Number(n)>Number(o);return this.log(`Comparison: ${n} > ${o} = ${r}`),r}else if(s.startsWith("<")){let o=s.substring(1),r=Number(n)<Number(o);return this.log(`Comparison: ${n} < ${o} = ${r}`),r}else {let o=false;if(typeof n=="boolean")s.toLowerCase()==="true"?o=n===true:s.toLowerCase()==="false"?o=n===false:o=false,this.log(`Boolean comparison: ${n} === ${s.toLowerCase()==="true"} = ${o}`);else if(typeof n=="number"){let r=Number(s);o=!isNaN(r)&&n===r,this.log(`Number comparison: ${n} === ${r} = ${o}`);}else {let r=String(n),d=String(s);o=r.toLowerCase()===d.toLowerCase(),this.log(`String comparison: '${r}' === '${d}' = ${o}`);}return o}}updateUIStates(t,e){let i=this.state.getState(e),a=this.querySelector(t,`[${c}${l.empty}]`);a&&(a.style.display=i.experts.length===0&&!i.loading?"":"none");let s=this.querySelector(document.body,`[${c}${l.listTarget}="${e}"]`);if(s){let n=s,o=i.hasNextPage;n.style.display=o?"":"none",n.disabled=i.loading,n.textContent=i.loading?"Loading...":"Load More";}}handleAction(t,e,i){if(t==="load-more"){let a=this.querySelector(document.body,`[${c}${l.listId}="${e}"]`),s=this.getAttr(a,l.program);a&&s?this.loadExperts(e,s,true):this.log(`Could not find list or program for target: ${e}`);}}updateFilterAndReload(t,e,i,a){let n={...this.state.getState(t).filters},o=a;i==="available"?o=a==="true":["minRate","maxRate"].includes(i)?o=a===""||a===null?void 0:Number(a):i==="languages"&&typeof a=="string"&&(o=a.split(",").map(r=>r.trim()).filter(r=>r),o.length===0&&(o=void 0)),o!==void 0&&o!==""?n[i]=o:delete n[i],this.state.updateState(t,{filters:n,offset:0}),this.log(`Filter updated for list ${t}, reloading. New filters:`,n),this.loadExperts(t,e,false);}wireFilterControls(){let t=this.querySelectorAll(document.body,"[data-contra-filter]");this.log(`Found ${t.length} filter controls to wire.`),t.forEach(e=>{let i=e.getAttribute("data-contra-filter"),a=e.getAttribute("data-contra-list-target");if(!i||!a){this.log("Filter control missing required attributes: data-contra-filter or data-contra-list-target",e);return}let s=this.querySelector(document.body,`[${c}list-id="${a}"]`);if(!s)return;let n=this.getAttr(s,l.program);if(!n)return;if(i==="location"&&e instanceof HTMLInputElement){this.initGooglePlacesAutocomplete(e,a,n);return}let o=e instanceof HTMLInputElement&&["text","search","number"].includes(e.type)?300:0,r=()=>{let h=this.getControlValue(e);this.updateFilterAndReload(a,n,i,h);},d=this.debounce(r,o),m=e instanceof HTMLInputElement&&["text","search"].includes(e.type)?"input":"change";e.addEventListener(m,d);});}debounce(t,e){let i;return (...a)=>{clearTimeout(i),e>0?i=window.setTimeout(()=>t.apply(this,a),e):t.apply(this,a);}}getAttr(t,e){return t.getAttribute(`${c}${e}`)}querySelector(t,e){return t.querySelector(e)}querySelectorAll(t,e){return Array.from(t.querySelectorAll(e))}parseFiltersFromElement(t){let e={};return Object.entries({available:"available",languages:"languages",location:"location","min-rate":"minRate","max-rate":"maxRate",sort:"sortBy",limit:"limit",offset:"offset"}).forEach(([a,s])=>{let n=this.getAttr(t,a);n!=null&&(s==="available"?e[s]=n==="true":s==="languages"?e[s]=n.split(",").map(o=>o.trim()):["minRate","maxRate","limit","offset"].includes(s)?e[s]=parseInt(n):e[s]=n);}),e.offset===void 0&&(e.offset=0),e}getControlValue(t){if(t instanceof HTMLInputElement)switch(t.type){case "checkbox":return t.checked;case "number":case "range":return t.valueAsNumber;default:return t.value}else if(t instanceof HTMLSelectElement)return t.multiple?Array.from(t.selectedOptions).map(e=>e.value):t.value;return null}showLoading(t,e){let i=this.querySelector(t,`[${c}${l.loading}]`);i&&(i.style.display=e?"":"none"),t.classList.toggle(this.config.loadingClass,e);}showError(t,e){let i=this.querySelector(t,`[${c}${l.error}]`);i&&(i.textContent=e.message,i.style.display=""),t.classList.add(this.config.errorClass),this.log("Error displayed",e);}dispatchEvent(t,e,i){let a=new CustomEvent(`contra:${e}`,{detail:i});t.dispatchEvent(a);}log(t,...e){this.config.debug&&console.log(`[ContraWebflow] ${t}`,...e);}async getAvailableFilters(t){let e=`https://contra.com/public-api/programs/${t}/filters`;this.log(`Fetching available filters for program: ${t}`);try{let i=await fetch(e,{headers:{"X-API-Key":this.config.apiKey,Accept:"application/json"}});if(!i.ok)throw new Error(`Failed to fetch filters: ${i.statusText}`);let a=await i.json();return this.log("Successfully fetched filters",a.data),a.data||[]}catch(i){return this.log("Error fetching available filters",i),[]}}populateFilterControls(t,e){if(!e||e.length===0)return;this.log(`Populating filter controls for list ${t} with`,e),this.querySelectorAll(document.body,`[data-contra-list-target="${t}"]`).forEach(a=>{let s=a.getAttribute("data-contra-filter"),n=e.find(o=>o.name===s);if(n&&n.options&&a instanceof HTMLSelectElement){this.log(`Populating options for filter '${s}'`,n.options);let o=a.firstElementChild?.cloneNode(true);a.innerHTML="",o&&o.nodeName==="OPTION"&&a.appendChild(o),n.options.forEach(r=>{let d=document.createElement("option");typeof r=="object"&&r.value?(d.value=r.value,d.textContent=r.label||r.value):(d.value=String(r),d.textContent=String(r)),a.appendChild(d);});}});}initGooglePlacesAutocomplete(t,e,i){if(typeof window.google>"u"||typeof window.google.maps>"u"){this.log("Google Maps API not loaded. Location filter will work as a text input."),t.addEventListener("change",()=>{this.updateFilterAndReload(e,i,"location",t.value);});return}this.log("Initializing Google Places Autocomplete on",t);let a=new window.google.maps.places.Autocomplete(t,{types:["(cities)"],fields:["place_id","formatted_address"]});a.addListener("place_changed",()=>{let s=a.getPlace();if(s&&s.place_id){let n=`${s.formatted_address} (${s.place_id})`;this.log("Place selected:",{formatted:n}),this.updateFilterAndReload(e,i,"location",n);}}),t.addEventListener("input",()=>{t.value.trim()===""&&(this.log("Location input cleared."),this.updateFilterAndReload(e,i,"location",""));});}};function f(){let u=document.getElementById("contra-config");if(!u){console.warn("[ContraWebflow] No config element found. Runtime not initialized.");return}try{let t=JSON.parse(u.textContent||"{}");if(!t.apiKey){console.error("[ContraWebflow] API key is required in config.");return}setTimeout(()=>{let i=new p(t);window.contraRuntime=i,i.init().catch(a=>{console.error("[ContraWebflow] Runtime initialization failed:",a);});},100);}catch(t){console.error("[ContraWebflow] Failed to parse config:",t);}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):document.readyState==="interactive"?setTimeout(f,50):f();
exports.ContraWebflowRuntime=p;//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map